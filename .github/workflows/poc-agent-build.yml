name: Rust Build on Windows

on:
  push:
    branches:
      - cicd-test
  workflow_dispatch:

jobs:
  poc_windows_x86_64_compile:
    name: poc_windows_x86_64_compile
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Cache cargo
      uses: actions/cache@v4
      with:
        path: ~/.cargo
        key: ${{ runner.arch }}-${{ runner.os }}-cargo-cache-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.arch }}-${{ runner.os }}-cargo-cache-

    - name: Download rustup-init
      run: curl.exe --output rustup-init.exe --url https://static.rust-lang.org/rustup/dist/x86_64-pc-windows-msvc/rustup-init.exe

    - name: Run rustup-init
      run: ./rustup-init.exe -vy

    - name: Install Rust Toolchain
      run: |
        rustup toolchain install stable-x86_64-pc-windows-msvc
        rustup default stable-x86_64-pc-windows-msvc

    - name: Get rust version
      shell: pwsh
      run: rustc --version

    - name: Install MinGW and NSIS with Chocolatey
      run: choco install -y mingw nsis

    - name: Install Rust Quality Tools
      run: |
        rustup component add clippy
        rustup component add rustfmt
        cargo install cargo-audit

    - name: Cargo Check
      run: cargo check

    - name: Cargo Clippy
      run: cargo clippy -- -D warnings

    - name: Cargo Format Check
      run: cargo fmt -- --check

    - name: Cargo Audit
      run: cargo audit

    - name: Cargo Build
      run: cargo build --release

    - name: Cargo Test
      run: cargo test --release


    - name: Cargo Test
      run: |
          cargo install cargo-cache
          cargo-cache -a clean-unref      